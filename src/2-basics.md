# أساسيات المحاكاة {#eb}

هذا الفصل الأول هو نظرة عامة على مفاهيم تطوير المحاكاة ونظام Chip-8. الفصول اللاحقة ستتضمن تنفيذًا للكود بلغة Rust. إذا لم تكن مهتمًا بـ Rust أو تفضل العمل دون أمثلة، فإن هذا الفصل سيعطي مقدمة عن الخطوات التي يقوم بها النظام الحقيقي، وما الذي نحتاج إلى محاكاته بأنفسنا، وكيف تتلاءم جميع الأجزاء معًا. إذا كنت جديدًا تمامًا على هذا الموضوع، فإن هذا الفصل سيوفر المعلومات التي تحتاجها لفهم ما ستقوم بتنفيذه.

## ما الذي يوجد في لعبة Chip-8؟

لنبدأ بسؤال بسيط. إذا أعطيتك ملف ROM[^1] لـ Chip-8، ما الذي يحتويه بالضبط؟ يحتاج الملف إلى أن يحتوي على كل منطق اللعبة والأصول الرسومية اللازمة لجعل اللعبة تعمل على الشاشة، ولكن كيف يتم تنظيم كل ذلك؟

هذا سؤال أساسي؛ هدفنا هو قراءة هذا الملف وجعل برنامجه يعمل. حسنًا، هناك طريقة واحدة لمعرفة ذلك، لذا دعنا نحاول فتح لعبة Chip-8 في محرر نصوص (مثل Notepad أو TextEdit أو أي محرر آخر تفضله). في هذا المثال، أستخدم لعبة `roms/PONG2` المضمنة مع هذا الدليل. ما لم تكن تستخدم محررًا متطورًا جدًا، فمن المحتمل أن ترى شيئًا مشابهًا للشكل 1.

![ملف ROM لـ Chip-8 بشكل خام](img/PONG2_raw.png)

هذا لا يبدو مفيدًا جدًا. في الواقع، يبدو تالفًا. لا تقلق، لعبتك (على الأرجح) بخير. جميع برامج الكمبيوتر هي في جوهرها مجرد أرقام محفوظة في ملف. يمكن أن تعني هذه الأرقام أي شيء تقريبًا؛ فقط مع السياق يمكن للكمبيوتر أن يعطي معنى لهذه القيم. تم تصميم محرر النصوص الخاص بك لعرض وتحرير النصوص بلغة مثل الإنجليزية، وبالتالي سيحاول تلقائيًا استخدام سياق يركز على اللغة مثل [ASCII](https://www.asciitable.com/).

لقد تعلمنا أن ملف Chip-8 الخاص بنا ليس مكتوبًا باللغة الإنجليزية العادية، وهو ما كنا نستطيع افتراضه بالفعل. إذن كيف يبدو؟ لحسن الحظ، توجد برامج لعرض المحتويات الخام للملف، لذا سنحتاج إلى استخدام أحد "محررات الست عشري" لعرض المحتويات الفعلية لملفنا.

![ملف ROM لـ Chip-8](img/PONG2.png)

في الشكل 2، الأرقام على يسار الخط العمودي هي قيم *الإزاحة* (offset)، وهي عدد البايتات التي نبتعدها عن بداية الملف. على الجانب الأيمن توجد القيم الفعلية المخزنة في الملف. يتم عرض كل من الإزاحات وقيم البيانات بالنظام الست عشري (سنتعامل مع النظام الست عشري بشكل كبير).

حسنًا، لدينا أرقام الآن، وهذا تحسن. إذا كانت هذه الأرقام لا تتوافق مع الحروف الإنجليزية، فماذا تعني؟ هذه هي *التعليمات* لوحدة المعالجة المركزية (CPU) لـ Chip-8. في الواقع، كل تعليمة تتكون من بايتين، ولهذا قمت بتجميعها في أزواج في لقطة الشاشة.

## ما هي وحدة المعالجة المركزية (CPU)؟

دعني أخذ لحظة لوصف الوظيفة التي توفرها وحدة المعالجة المركزية (CPU) لأولئك الذين ليسوا على دراية بها. وحدة المعالجة المركزية، لأغراضنا، تقوم بالعمليات الحسابية. هذا كل شيء. عندما أقول "تقوم بالعمليات الحسابية"، فإن هذا يشمل العناصر المعتادة مثل الجمع والطرح والتحقق مما إذا كان الرقمان متساويين أم لا. هناك أيضًا عمليات إضافية مطلوبة لتشغيل اللعبة، مثل القفز إلى أقسام مختلفة من الكود، أو جلب الأرقام وحفظها. ملف اللعبة يتكون بالكامل من عمليات حسابية يجب على وحدة المعالجة المركزية تنفيذها.

جميع العمليات الحسابية التي يمكن لـ Chip-8 تنفيذها لها رقم مقابل، يسمى *رمز العملية* (opcode). يمكن رؤية قائمة كاملة برموز عمليات Chip-8 على [هذه الصفحة](#ot). عندما يحين وقت تنفيذ تعليمة أخرى (يشار إليها أيضًا باسم *tick* أو *cycle*)، ستقوم المحاكاة بجلب رمز العملية التالي من ملف ROM الخاص باللعبة وتنفيذ العملية المحددة في جدول رموز العمليات؛ سواء كانت جمعًا أو طرحًا أو تحديثًا لما يتم رسمه على الشاشة، أو أي شيء آخر.

ماذا عن المعاملات؟ ليس كافيًا أن نقول "حان وقت الجمع"، بل تحتاج إلى رقمين لتجمعهما معًا، بالإضافة إلى مكان لوضع الناتج عند الانتهاء. تقوم الأنظمة الأخرى بذلك بشكل مختلف، ولكن بايتان لكل عملية تعطي الكثير من الأرقام المحتملة، أكثر بكثير من 35 عملية يمكن لـ Chip-8 تنفيذها بالفعل. يتم استخدام الأرقام الإضافية لتضمين معلومات إضافية في رمز العملية. يختلف التخطيط الدقيق لهذه المعلومات بين رموز العمليات. يستخدم جدول رموز العمليات `N` للإشارة إلى الأرقام الست عشرية الحرفية. `N` لرقم واحد، `NN` لرقمين، و`NNN` لثلاثة أرقام حرفية، أو لتحديد *سجل* عبر `X` أو `Y`.

## ما هي السجلات (Registers)؟

وهذا يقودنا إلى موضوعنا التالي. ما هي السجلات؟ *السجل* هو مكان مخصص لتخزين بايت واحد لاستخدامه في التعليمات. قد يبدو هذا مشابهًا للذاكرة العشوائية (RAM)، وبعض النواحي هو كذلك. بينما تعد الذاكرة العشوائية مكانًا كبيرًا لتخزين البيانات، فإن السجلات عادةً ما تكون قليلة العدد، ولها أسماء محددة، ويتم استخدامها مباشرة عند تنفيذ رمز العملية. بالنسبة للعديد من أجهزة الكمبيوتر، إذا كنت تريد استخدام قيمة في الذاكرة العشوائية، فيجب نسخها إلى سجل أولاً.

يحتوي Chip-8 على ستة عشر سجلًا يمكن للمبرمج استخدامها بحرية، تُسمى من V0 إلى VF (0-15 بالنظام الست عشري). كمثال على كيفية عمل السجلات، دعنا ننظر إلى إحدى عمليات الجمع في جدول رموز العمليات. هناك عملية لجمع قيم سجلين معًا، VX += VY، مشفرة كـ `8XY4`. يتم استخدام `8XY4` لمطابقة رموز العمليات. إذا بدأ رمز العملية الحالي بـ 8 وانتهى بـ 4، فإن هذه هي العملية المطابقة. الرقمان في المنتصف يحددان السجلات التي سنستخدمها. لنفترض أن رمز العملية لدينا هو `8124`. يبدأ بـ 8 وينتهي بـ 4، لذا نحن في المكان الصحيح. بالنسبة لهذه التعليمات، سنستخدم القيم المخزنة في V1 وV2، حيث تتطابق مع الرقمين الآخرين. لنفترض أن V1 يحتوي على 5 وV2 يحتوي على 10، فإن هذه العملية ستجمع هذين الرقمين وتستبدل ما كان في V1، وبالتالي سيحتوي V1 الآن على 15.

يحتوي Chip-8 على عدد قليل من السجلات الإضافية، ولكنها تخدم أغراضًا محددة للغاية. أحد أهمها هو *عداد البرنامج* (PC)، والذي يمكنه تخزين قيمة بعرض 16 بت. لقد أشرت بشكل غامض إلى "رمز العملية الحالي"، ولكن كيف نتابع أين نحن؟ المحاكاة الخاصة بنا تحاكي جهاز كمبيوتر يعمل على برنامج. تحتاج إلى البدء من بداية اللعبة والانتقال من رمز عملية إلى آخر، وتنفيذ التعليمات كما يتم إخبارها. يحتفظ PC بفهرس التعليمات التي نعمل عليها حاليًا. لذا سيبدأ من البايت الأول من اللعبة، ثم ينتقل إلى الثالث (تذكر أن جميع رموز العمليات تتكون من بايتين)، وهكذا دواليك. يمكن لبعض التعليمات أيضًا أن تخبر PC بالانتقال إلى مكان آخر في اللعبة، ولكن بشكل افتراضي سيتحرك للأمام رمزًا تلو الآخر.

## ما هي الذاكرة العشوائية (RAM)؟

لدينا ستة عشر سجلًا V، ولكن حتى لنظام بسيط مثل Chip-8، نرغب حقًا في القدرة على تخزين أكثر من 16 رقمًا في وقت واحد. هنا تأتي الذاكرة العشوائية (RAM). ربما تكون على دراية بها في سياق جهاز الكمبيوتر الخاص بك، ولكن الذاكرة العشوائية هي مصفوفة كبيرة من الأرقام يمكن لوحدة المعالجة المركزية استخدامها كما تشاء. Chip-8 ليس نظامًا ماديًا، لذا لا يوجد كمية قياسية من الذاكرة العشوائية التي يجب أن يحتويها. ومع ذلك، اتفق مطورو المحاكاة على 4096 بايت (4 كيلوبايت)، لذا سيكون لنظامنا القدرة على تخزين ما يصل إلى 4096 رقمًا بعرض 8 بت في ذاكرته العشوائية، وهو أكثر بكثير مما ستستخدمه معظم الألعاب.

الآن، حان وقت تفصيل مهم: وحدة المعالجة المركزية لـ Chip-8 لديها وصول حر للقراءة والكتابة في الذاكرة العشوائية كما تشاء. ومع ذلك، لا يمكنها الوصول مباشرة إلى ملف ROM الخاص باللعبة. مع اسم مثل "ذاكرة القراءة فقط"، من الآمن افتراض أننا لن نكون قادرين على الكتابة فوقها، ولكن وحدة المعالجة المركزية لا يمكنها القراءة من ROM أيضًا؟ بينما تحتاج وحدة المعالجة المركزية إلى القدرة على قراءة ملف ROM الخاص باللعبة، فإنها تحقق ذلك بشكل غير مباشر، عن طريق نسخ اللعبة بالكامل إلى الذاكرة العشوائية[^2] عند بدء تشغيل اللعبة. من البطيء وغير الفعال فتح ملف اللعبة فقط لقراءة جزء صغير من البيانات مرارًا وتكرارًا. بدلاً من ذلك، نريد أن نتمكن من نسخ أكبر قدر ممكن من البيانات في الذاكرة العشوائية لاستخدامها بسرعة أكبر. التفصيل الآخر هو أنه بشكل مربك بعض الشيء، لا يتم تحميل بيانات ROM في بداية الذاكرة العشوائية. بدلاً من ذلك، يتم إزاحتها بمقدار 512 بايت (0x200). هذا يعني أن البايت الأول من اللعبة يتم تحميله في بداية الذاكرة العشوائية عند العنوان 0x200. البايت الثاني من ROM يتم تحميله في 0x201، وهكذا.

لماذا لا يقوم Chip-8 بتخزين اللعبة في بداية الذاكرة العشوائية وينتهي الأمر؟ عندما تم تصميم Chip-8، كانت أجهزة الكمبيوتر تحتوي على ذاكرة عشوائية محدودة للغاية، وكان يمكن تشغيل برنامج واحد فقط في وقت معين. تم تخصيص أول 0x200 بايت لتشغيل برنامج Chip-8 نفسه. وبالتالي، يحتاج مطورو محاكاة Chip-8 الحديثة إلى أخذ ذلك في الاعتبار، حيث لا تزال الألعاب تُطور مع هذا المفهوم. سيقوم نظامنا في الواقع باستخدام جزء صغير من هذه المساحة الفارغة، ولكننا سنغطي ذلك لاحقًا.

[^1]: 'ROM' تعني "ذاكرة القراءة فقط" (Read-only memory). وهي نوع من الذاكرة يتم كتابتها بشكل دائم أثناء التصنيع ولا يمكن تعديلها بواسطة نظام الكمبيوتر. لأغراض هذا الدليل، سيتم استخدام "ملف ROM" بالتبادل مع "ملف اللعبة".

[^2]: لذلك، فإن ألعاب Chip-8 لها حجم أقصى يبلغ 4 كيلوبايت، وإذا كانت أكبر من ذلك، فلا يمكن تحميلها بالكامل.

\newpage
